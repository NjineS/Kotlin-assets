name: Extract Kotlin assets

on:
  schedule:
    - cron: "0 8 * * 0"   # Every Sunday 08:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  extract:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget dpkg grep

      - name: Get latest Kotlin version
        id: get_version
        run: |
          BASE_URL="https://packages.termux.dev/apt/termux-main/pool/main/k/kotlin/"
          wget -qO- "$BASE_URL" | grep -o 'kotlin_[0-9.]\+_all\.deb' | sort -V | tail -n1 > latest.txt
          FILE=$(cat latest.txt)
          VERSION=$(echo "$FILE" | sed -E 's/kotlin_([0-9.]+)_all\.deb/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "file=$FILE" >> $GITHUB_OUTPUT
          echo "Detected Kotlin version: $VERSION"

      - name: Download and extract Kotlin
        run: |
          set -e
          BASE_URL="https://packages.termux.dev/apt/termux-main/pool/main/k/kotlin/"
          VERSION="${{ steps.get_version.outputs.version }}"
          FILE="kotlin_${VERSION}_all.deb"
          URL="${BASE_URL}${FILE}"

          echo "⬇️ Downloading $URL"
          wget -q "$URL" -O "$FILE"

          mkdir -p kotlin-extract/tmp
          dpkg-deb -x "$FILE" kotlin-extract/tmp

          SRC="kotlin-extract/tmp/data/data/com.termux/files/usr"
          DEST="kotlin"

          if [ -d "$SRC" ]; then
            rm -rf "$DEST"
            mkdir -p "$DEST"
            cp -a "$SRC/." "$DEST/"
            echo "✅ Extracted full Kotlin assets"
          else
            echo "❌ Extraction failed: $SRC not found"
            exit 1
          fi

          rm -rf kotlin-extract/tmp
          rm -f "$FILE"

      - name: Commit and push Kotlin assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git fetch origin main
          git checkout main
          git reset --hard origin/main

          if [ -n "$(git status --porcelain kotlin)" ]; then
            git add kotlin
            git commit -m "Extracted Kotlin ${{ steps.get_version.outputs.version }} assets"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git main
          else
            echo "No updates found."
          fi
